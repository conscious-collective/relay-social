name: Deploy Preview on Comment

on:
  issue_comment:
    types: [created]

jobs:
  deploy:
    # Only run on PR comments that start with /deploy
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/deploy')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha,
              number: pr.data.number
            };

      - name: Check if tests passed
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ steps.pr.outputs.result }};
            
            // Get check runs for this commit
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.sha
            });
            
            // Find CI workflow runs
            const ciRuns = checkRuns.check_runs.filter(run => 
              run.name.includes('Test') || run.name.includes('CI')
            );
            
            if (ciRuns.length === 0) {
              throw new Error('No CI runs found. Run tests first.');
            }
            
            const allPassed = ciRuns.every(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );
            
            if (!allPassed) {
              throw new Error('Tests must pass before deployment. Check CI status.');
            }
            
            core.info('âœ… All tests passed');

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ fromJson(steps.pr.outputs.result).ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd packages/dashboard
          vercel deploy --token=$VERCEL_TOKEN --yes > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV

      - name: Comment deployment URL
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = process.env.DEPLOYMENT_URL;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ Preview deployed!\n\n${deploymentUrl}`
            });
