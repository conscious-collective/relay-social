<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Calendar - Relay Social</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .header { background: white; padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; color: #333; }
    .header .views { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn.active { background: #4f46e5; color: white; }
    
    .calendar-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .calendar-header h2 { font-size: 20px; color: #333; }
    .nav-btns { display: flex; gap: 10px; }
    .nav-btn { padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; }
    
    /* Monthly View */
    .monthly-view { display: none; }
    .monthly-view.active { display: block; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .day-header { background: #f9fafb; padding: 12px; text-align: center; font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase; }
    .day-cell { background: white; min-height: 120px; padding: 8px; cursor: pointer; }
    .day-cell:hover { background: #f9fafb; }
    .day-number { font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
    .day-cell.today { background: #fef3c7; }
    .day-cell.other-month { background: #f9fafb; }
    .day-cell.other-month .day-number { color: #9ca3af; }
    
    .post-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin: 2px; }
    .post-dot.draft { background: #6b7280; }
    .post-dot.scheduled { background: #3b82f6; }
    .post-dot.published { background: #10b981; }
    .post-dot.failed { background: #ef4444; }
    
    /* Daily View */
    .daily-view { display: none; }
    .daily-view.active { display: block; }
    .day-header-info { margin-bottom: 20px; }
    .day-header-info h2 { font-size: 24px; margin-bottom: 8px; }
    .day-header-info .date { color: #6b7280; }
    
    .post-list { display: flex; flex-direction: column; gap: 12px; }
    .post-card { background: white; border-radius: 8px; padding: 16px; border: 1px solid #e5e7eb; cursor: pointer; }
    .post-card:hover { border-color: #4f46e5; }
    .post-card .time { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
    .post-card .content { font-size: 14px; color: #374151; margin-bottom: 8px; }
    .post-card .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .post-card .status.draft { background: #f3f4f6; color: #6b7280; }
    .post-card .status.scheduled { background: #dbeafe; color: #2563eb; }
    .post-card .status.published { background: #d1fae5; color: #059669; }
    .post-card .status.failed { background: #fee2e2; color: #dc2626; }
    
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 24px; width: 500px; max-width: 90%; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { font-size: 18px; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #374151; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
    .form-group textarea { min-height: 100px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    
    .loading { text-align: center; padding: 40px; color: #6b7280; }
    .error { text-align: center; padding: 40px; color: #ef4444; }
    
    .post-count { font-size: 11px; color: #6b7280; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìÖ Content Calendar</h1>
    <div class="views">
      <button class="btn btn-secondary active" id="monthlyBtn" onclick="switchView('monthly')">Monthly</button>
      <button class="btn btn-secondary" id="dailyBtn" onclick="switchView('daily')">Daily</button>
      <button class="btn btn-primary" onclick="openModal()">+ New Post</button>
    </div>
  </div>
  
  <div class="calendar-container">
    <!-- Monthly View -->
    <div class="monthly-view active" id="monthlyView">
      <div class="calendar-header">
        <h2 id="monthYear">January 2026</h2>
        <div class="nav-btns">
          <button class="nav-btn" onclick="changeMonth(-1)">‚Üê Prev</button>
          <button class="nav-btn" onclick="changeMonth(1)">Next ‚Üí</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    
    <!-- Daily View -->
    <div class="daily-view" id="dailyView">
      <div class="day-header-info">
        <h2 id="selectedDate">January 1, 2026</h2>
        <p class="date" id="dateSubtitle">No posts scheduled</p>
      </div>
      <div class="post-list" id="dayPosts"></div>
    </div>
  </div>
  
  <!-- Post Modal -->
  <div class="modal" id="postModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">New Post</h3>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <form id="postForm">
        <input type="hidden" id="postId">
        <div class="form-group">
          <label>Content</label>
          <textarea id="postContent" placeholder="What's on your mind?"></textarea>
        </div>
        <div class="form-group">
          <label>Scheduled Date & Time</label>
          <input type="datetime-local" id="postSchedule">
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="postStatus">
            <option value="draft">Draft</option>
            <option value="scheduled">Scheduled</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Post</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let posts = [];
    let selectedDate = new Date();
    let currentView = 'monthly';
    let token = localStorage.getItem('relay_token') || prompt('Enter your API token:');
    if (token) localStorage.setItem('relay_token', token);
    
    const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
    
    async function fetchPosts() {
      try {
        const res = await fetch(`${API_URL}/posts`, { headers });
        const data = await res.json();
        posts = data.posts?.results || [];
        renderCalendar();
        renderDailyView();
      } catch (e) {
        console.error('Failed to fetch posts:', e);
      }
    }
    
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const monthYear = document.getElementById('monthYear');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      monthYear.textContent = `${months[currentMonth]} ${currentYear}`;
      
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
      
      const today = new Date();
      
      let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div class="day-header">${d}</div>`).join('');
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="day-cell other-month"><div class="day-number">${day}</div></div>`;
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayPosts = posts.filter(p => {
          if (!p.scheduled_at) return false;
          const postDate = new Date(p.scheduled_at).toISOString().split('T')[0];
          return postDate === dateStr;
        });
        
        const isToday = today.getDate() === day && today.getMonth() === currentMonth && today.getFullYear() === currentYear;
        const dots = dayPosts.map(p => `<span class="post-dot ${p.status}"></span>`).join('');
        
        html += `<div class="day-cell ${isToday ? 'today' : ''}" onclick="selectDate(${currentYear}, ${currentMonth}, ${day})">
          <div class="day-number">${day}</div>
          ${dots}
          ${dayPosts.length ? `<div class="post-count">${dayPosts.length} post${dayPosts.length > 1 ? 's' : ''}</div>` : ''}
        </div>`;
      }
      
      // Next month days
      const remaining = 42 - (firstDay + daysInMonth);
      for (let day = 1; day <= remaining; day++) {
        html += `<div class="day-cell other-month"><div class="day-number">${day}</div></div>`;
      }
      
      grid.innerHTML = html;
    }
    
    function renderDailyView() {
      const dateStr = selectedDate.toISOString().split('T')[0];
      const dayPosts = posts.filter(p => {
        if (!p.scheduled_at) return false;
        const postDate = new Date(p.scheduled_at).toISOString().split('T')[0];
        return postDate === dateStr;
      });
      
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('selectedDate').textContent = `${months[selectedDate.getMonth()]} ${selectedDate.getDate()}, ${selectedDate.getFullYear()}`;
      document.getElementById('dateSubtitle').textContent = `${dayPosts.length} post${dayPosts.length !== 1 ? 's' : ''} scheduled`;
      
      const list = document.getElementById('dayPosts');
      if (dayPosts.length === 0) {
        list.innerHTML = '<p class="loading">No posts scheduled for this day. Click "+ New Post" to create one.</p>';
        return;
      }
      
      list.innerHTML = dayPosts.map(post => {
        const time = post.scheduled_at ? new Date(post.scheduled_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
        return `<div class="post-card" onclick="editPost('${post.id}')">
          <div class="time">${time}</div>
          <div class="content">${post.content || 'No content'}</div>
          <span class="status ${post.status}">${post.status}</span>
        </div>`;
      }).join('');
    }
    
    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }
    
    function selectDate(year, month, day) {
      selectedDate = new Date(year, month, day);
      switchView('daily');
    }
    
    function switchView(view) {
      currentView = view;
      document.getElementById('monthlyBtn').className = `btn btn-secondary ${view === 'monthly' ? 'active' : ''}`;
      document.getElementById('dailyBtn').className = `btn btn-secondary ${view === 'daily' ? 'active' : ''}`;
      document.getElementById('monthlyView').className = `monthly-view ${view === 'monthly' ? 'active' : ''}`;
      document.getElementById('dailyView').className = `daily-view ${view === 'daily' ? 'active' : ''}`;
      if (view === 'daily') renderDailyView();
    }
    
    function openModal(postId = null) {
      document.getElementById('postModal').classList.add('active');
      document.getElementById('postForm').reset();
      document.getElementById('postId').value = '';
      document.getElementById('modalTitle').textContent = 'New Post';
      
      if (postId) {
        const post = posts.find(p => p.id === postId);
        if (post) {
          document.getElementById('modalTitle').textContent = 'Edit Post';
          document.getElementById('postId').value = post.id;
          document.getElementById('postContent').value = post.content || '';
          document.getElementById('postStatus').value = post.status || 'draft';
          if (post.scheduled_at) {
            const date = new Date(post.scheduled_at);
            document.getElementById('postSchedule').value = date.toISOString().slice(0, 16);
          }
        }
      }
    }
    
    function closeModal() {
      document.getElementById('postModal').classList.remove('active');
    }
    
    function editPost(id) {
      openModal(id);
    }
    
    document.getElementById('postForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('postId').value;
      const content = document.getElementById('postContent').value;
      const status = document.getElementById('postStatus').value;
      const scheduledAt = document.getElementById('postSchedule').value;
      
      const payload = {
        content,
        status,
        account_id: 'acc_demo',
        scheduled_at: scheduledAt ? new Date(scheduledAt).getTime() : null
      };
      
      try {
        if (id) {
          await fetch(`${API_URL}/posts/${id}`, { method: 'PUT', headers, body: JSON.stringify(payload) });
        } else {
          await fetch(`${API_URL}/posts`, { method: 'POST', headers, body: JSON.stringify(payload) });
        }
        closeModal();
        fetchPosts();
      } catch (e) {
        alert('Failed to save post: ' + e.message);
      }
    };
    
    // Initialize
    fetchPosts();
  </script>
</body>
</html>
