#!/usr/bin/env bash
# Schedule or publish a social media post

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/helpers.sh"

# Parse arguments
CONTENT=""
ACCOUNT=""
MEDIA=""
SCHEDULE=""
PUBLISH_NOW=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --account)
      ACCOUNT="$2"
      shift 2
      ;;
    --media)
      MEDIA="$2"
      shift 2
      ;;
    --in)
      SCHEDULE="$2"
      shift 2
      ;;
    --at)
      SCHEDULE="$2"
      shift 2
      ;;
    --now)
      PUBLISH_NOW=true
      shift
      ;;
    *)
      if [[ -z "$CONTENT" ]]; then
        CONTENT="$1"
      fi
      shift
      ;;
  esac
done

# Validate
if [[ -z "$CONTENT" ]]; then
  echo "Error: Content is required"
  echo "Usage: relay-post \"content\" --account <name> [--media URL] [--in TIME | --at TIMESTAMP | --now]"
  exit 1
fi

if [[ -z "$ACCOUNT" ]]; then
  echo "Error: Account is required (use --account)"
  exit 1
fi

# Get account ID
ACCOUNT_ID=$(get_account_id "$ACCOUNT")
if [[ -z "$ACCOUNT_ID" ]]; then
  echo "Error: Account not found: $ACCOUNT"
  echo "Run 'relay-accounts' to list available accounts"
  exit 1
fi

# Build media URLs array
MEDIA_URLS="[]"
if [[ -n "$MEDIA" ]]; then
  # Split by comma if multiple URLs
  IFS=',' read -ra URLS <<< "$MEDIA"
  MEDIA_URLS=$(printf '%s\n' "${URLS[@]}" | jq -R . | jq -s .)
fi

# Build request payload
if [[ "$PUBLISH_NOW" == true ]]; then
  # Create as draft, then publish
  PAYLOAD=$(jq -n \
    --arg account_id "$ACCOUNT_ID" \
    --arg content "$CONTENT" \
    --argjson media_urls "$MEDIA_URLS" \
    '{
      account_id: $account_id,
      content: $content,
      media_urls: $media_urls,
      status: "draft"
    }')
else
  # Schedule for later
  if [[ -z "$SCHEDULE" ]]; then
    echo "Error: Must specify --in, --at, or --now"
    exit 1
  fi
  
  SCHEDULED_AT=$(schedule_time "$SCHEDULE")
  if [[ $? -ne 0 ]]; then
    exit 1
  fi
  
  PAYLOAD=$(jq -n \
    --arg account_id "$ACCOUNT_ID" \
    --arg content "$CONTENT" \
    --argjson media_urls "$MEDIA_URLS" \
    --argjson scheduled_at "$SCHEDULED_AT" \
    '{
      account_id: $account_id,
      content: $content,
      media_urls: $media_urls,
      status: "scheduled",
      scheduled_at: $scheduled_at
    }')
fi

# Create post
RESPONSE=$(relay_api POST "/api/posts" "$PAYLOAD")
POST_ID=$(echo "$RESPONSE" | jq -r '.post.id')

if [[ -z "$POST_ID" || "$POST_ID" == "null" ]]; then
  echo "Error creating post:"
  echo "$RESPONSE" | jq
  exit 1
fi

# If --now, publish immediately
if [[ "$PUBLISH_NOW" == true ]]; then
  echo "üìÆ Publishing post $POST_ID..."
  PUBLISH_RESPONSE=$(relay_api POST "/api/posts/$POST_ID/publish" "")
  
  if echo "$PUBLISH_RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
    echo "‚ùå Failed to publish:"
    echo "$PUBLISH_RESPONSE" | jq -r '.error'
    exit 1
  fi
  
  echo "‚úÖ Published successfully!"
  echo "$PUBLISH_RESPONSE" | jq '.post | {id, status, platformPostId}'
else
  SCHEDULED_TIME=$(echo "$RESPONSE" | jq -r '.post.scheduledAt')
  echo "‚è∞ Post scheduled!"
  echo "   ID: $POST_ID"
  echo "   Time: $SCHEDULED_TIME"
  echo "   Account: $ACCOUNT"
fi
